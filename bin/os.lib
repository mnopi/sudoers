# shellcheck shell=sh

# Color library
#
_os_cache_dir="${HOME}/.cache/color.lib"
_os_cache_file="${_os_cache_dir}/colors"
_os_sourced=false
if [ "${0##*/}" = 'sh' ] || (return 0 2>/dev/null); then
  _os_sourced=true
  # already sourced and colors exported
  { [ ! "${Red-}" ] || [ ! -r "${_os_cache_file}" ]; } || { return 0 2>/dev/null || exit 0; }
fi

# Default unset, debug messages are not shown.
# Needs to be activated with DEBUG=1 or --debug.
export DEBUG
# Default unset, messages are shown based on their variable for DEBUG, VERBOSE and WARNING; ok and error printed.
# Needs to be silent with --quiet (takes precedence over DEBUG, VERBOSE and WARNING).
export QUIET
# Default unset, verbose messages are not shown.
# Needs to be activated with VERBOSE=1 or --verbose.
export VERBOSE
# Default unset, warning messages are not shown.
# Needs to be activated with WARNING=1 or --warning.
export WARNING

####################################### _os_main
# Show colors and functions examples when not sourced
# ######################################
# shellcheck disable=SC3053,SC3057,SC3040
_os_main() {
  . strict.lib 2>/dev/null || { set -eu; PATH="$("$(dirname "${0}")/colon")" && export PATH && . strict.lib; }
  for arg do
    case "${arg}" in
      -h|--help) usage "${0}" ;;
      --desc) desc "${0}" ;;
      --test) _os_test ;;
      --version) sudoers --version ;;
    esac
    exit
  done
  _os_show
}

####################################### _os_set
# Set color
# ######################################
_os_set() {
  _oss="${_colors}${_os_sep}${1}"
  echo "export ${1}='\033[${2}${3}'" >> "${_os_cache_file}"
}

####################################### _os_show
# Show colors and helper functions output
# ######################################
_os_show(){
  if [ "${BASH_VERSION-}" ]; then
    for i in ${_colors}; do
      # shellcheck disable=SC3053
      printf "%b\n" "${!i}${i}${Reset}"
    done
  fi

  echo

  export VAR1=1 VAR2=2
  debug Debug Message: not shown "DEBUG unset"
  DEBUG=1 debug VAR1
  DEBUG=1 debug VAR1 VAR2
  DEBUG=1 debug
  DEBUG=1
  QUIET=1 debug Not Shown: "QUIET=1"

  echo

  error Error Message
  error
  QUIET=1 error Not Shown: "QUIET=1"

  echo

  ok Ok Message
  ok
  QUIET=1 ok Not Shown: "QUIET=1"

  echo

  VERBOSE=1 verbose Verbose Message: "VERBOSE=1"
  VERBOSE=1 verbose
  VERBOSE=1
  QUIET=1 verbose Not Shown: "QUIET=1"

  echo

  WARNING=1 warning Warning Message: "WARNING=1"
  WARNING=1 warning
  WARNING=1
  QUIET=1 warning Not shown: "QUIET=1"

  echo

  die Die Message

}

####################################### _os_test
# Test colors and helper functions output
# ######################################
_os_test() {
  rm -f "${_os_cache_file}"
  output="$(. "${0}" 2>&1)"
  # > Colors: Cached
  echo "${output}" | grep -q "Colors: Cached"
  # > Colors: Sourced
  echo "${output}" | grep -q "Colors: Sourced"

  [ -r "${_os_cache_file}" ]

  unset Red
  output="$(. "${0}" 2>&1)"
  # No: > Colors: Cached
  echo "${output}" | grep -q "Colors: Cached" && false
  # > Colors: Sourced
  echo "${output}" | grep -q "Colors: Sourced" && false

  output="$(. "${0}" 2>&1)"
  # No: > Colors: Cached
  echo "${output}" | grep -q "Colors: Cached" && false
  # No: > Colors: Sourced
  echo "${output}" | grep -q "Colors: Sourced" && false

  output="$("${0}" 2>&1)"

  # + color.lib[80]: VAR1=1, VAR2=2
  echo "${output}" | grep -qE '\+.*color.lib\[.*].*: .*VAR1=1,.*$'
  # + color.lib[81]: VAR1=1
  echo "${output}" | grep -E '\+.*color.lib\[.*].*: .*VAR1=1.*$' | grep -qv ','
  # + color.lib[82]
  echo "${output}" | grep -E '\+.*color.lib\[.*].*$' | grep -qv ':'

  # x color.lib[88]: Error Message
  echo "${output}" | grep -qE 'x.*color.lib\[.*].*: .*Error Message.*$'
  # x color.lib[89]
  echo "${output}" | grep -E 'x.*color.lib\[.*].*$' | grep -qv ':'

  # ✓ Ok Message
  echo "${output}" | grep -qE '✓*Ok Message.*$'
  # ✓
  echo "${output}" | grep -E '✓*$' | grep -qv ' '

  # > Verbose Message: VERBOSE=1
  echo "${output}" | grep -qE '>*Verbose Message: VERBOSE=1.*$'
  # >
  echo "${output}" | grep -E '>*$' | grep -qv ' '


  # ! color.lib[107]: Warning Message: WARNING=1
  echo "${output}" | grep -qE '!.*color.lib\[.*].*: .*Warning Message: WARNING=1.*$'
  # ! color.lib[108]
  echo "${output}" | grep -E '!.*color.lib\[.*].*$' | grep -qv ':'

  # ✓ Die Message
  echo "${output}" | grep -qE '✓*Die Message.*$'

  set +e; echo "${output}" | grep -q 'Not Shown' && false
}

####################################### _oss_set
# Set Colors
# https://www.lihaoyi.com/post/BuildyourownCommandLinewithANSIescapecodes.html
# Contain the unicode Ansi escapes (\u001b) to be used in any language, e.g. Java, Python and Javascript).
# Globals:
#   _oss                All color names.
#   <Name>                 Color foreground.
#   <Name>Bg               Color background.
#   <Name>Bold             Color bold/bright.
#   <Name>Dim              Color dimmed.
#   <Name>Under            Color underscored.
#   Reset                  Reset color.
# ######################################
_oss_set() {
  if [ ! -r "${_os_cache_file}" ]; then
    [ -d "${_os_cache_dir}" ] || mkdir "${_os_cache_dir}"
    _os_index=0; _os_sep=''; _oss=""
    _os_set 'Reset' "${_os_index}" 'm'
    _os_sep=' '
    for _os_name in Black Red Green Yellow Blue Magenta Cyan Grey; do
      _os_set "${_os_name}" "3${_os_index}" 'm'
      _os_set "${_os_name}Bold" "3${_os_index}" ';1m'
      _os_set "${_os_name}Dim" "3${_os_index}" ';2m'
      _os_set "${_os_name}Under" "3${_os_index}" ';4m'
      _os_set "${_os_name}Invert" "3${_os_index}" ';7m'
      _os_set "${_os_name}Bg" "4${_os_index}" 'm'
      export _os_index="$((_os_index+1))"
    done
    echo "_oss='${_oss}'" >> "${_os_cache_file}"
    unset -f _os_set
    unset _os_name _os_index _os_sep
    verbose Colors: Cached
  fi
  . "${_os_cache_file}"
}

_oss_set
$_os_sourced || _os_main "${@}"
verbose Colors: Sourced

unset _os_cache_file _os_cache_dir _os_sourced _oss
unset -f _os_main _os_show _os_test _oss_set

cat >/tmp/z <<EOF
. /Users/jose/sudoers/bin/color.lib
warning Warning: 1
warning Warning: 2
VAR1=1
debug VAR1
VAR2=2
debug VAR1 VAR2
debug
echo "\${Red}"
EOF
chmod +x /tmp/z

# VERBOSE=1 . /Users/jose/sudoers/bin/color.lib
# VERBOSE=1 /tmp/z
# WARNING=1 /tmp/z
# DEBUG=1 /tmp/z
