#!/bin/sh
# shellcheck disable=SC2086

#
# sudoers.d update

# curl -fsSL mnopi.com/sudoers | sh
# curl -fsSL mnopi.com/sudoers | sh -s error
# curl -fsSL mnopi.com/sudoers | sh -s correct
# sudo rm /etc/sudoers.sh; curl -fsSL mnopi.com/sudoers | sh

set -eu

stderr() { [ $? -eq 0 ] || {
  echo
  sed "s/^/$(printf '\e[35m%s' '>')$(printf '\e[0m%s' ' ')/" "/tmp/${name}"
  rm "/tmp/${name}"
}; }

print() (
  rc=$?
  export PROMPT_EOL_MARK=''
  case $rc in
    0) printf '\e[32m%s' ✔ ;;
    *)
      printf '\e[31m%s' ✗
      exit="exit $rc"
      ;;
  esac
  printf '\e[0m%s\n' " ${name}: $*"
  eval "${exit-}"
)


  name='sudoers'
  exec 2>"/tmp/${name}"
  trap stderr EXIT

  defaults='always_set_home, !authenticate, !env_reset, !logfile, shell_noargs, !syslog'
  name='sudoers'
  file="/etc/${name}.sh"
  flag='-S'
  PASSWORD="${1:-}"
  runchroot=', runchroot=*'
  man sudoers | grep -q runchroot || runchroot=''
  runcwd=', runcwd=*'
  man sudoers | grep -q runcwd || runcwd=''
  SUDOC='/usr/bin/sudo'
  tmp="$(mktemp)"
  umask=0022

  cat >"${tmp}" <<EOF
# Auto generated by: ${name}

User_Alias ADMINS = %admin, %sudo, %wheel
Defaults:ADMINS ${defaults}, umask=${umask}, umask_override${runchroot}${runcwd}
EOF

  test -x "${SUDOC}" || {
    SUDOC=''
    flag=''
    mkdir -p /etc/sudoers.d
  }

  if [ ! "${PASSWORD}" ]; then
    if [ -f "${file}" ]; then
      # shellcheck source=/etc/sudoers.sh
      . "${file}"
    elif [ "${SUDOC}" ]; then
      printf '%s' "Enter admin password: "
        save_state="$(stty -g)"
        # IFS='' read -r -n 1 -d '' "$@"
        IFS='' read -r PASSWORD
        stty "${save_state}"
    fi
  fi

  echo "${PASSWORD}" | ${SUDOC} ${flag} true || print Incorrect Password: "${PASSWORD}"
  echo "${PASSWORD}" | ${SUDOC} ${flag} rm -rf /etc/sudoers.d/*
  [ ! "${SUDOC}" ] || ${SUDOC} -K; echo "${PASSWORD}" | ${SUDOC} ${flag} true || print Incorrect Password: "${PASSWORD}"
  echo "${PASSWORD}" | ${SUDOC} ${flag} cp "${tmp}" "/etc/sudoers.d/${name}" && print "/etc/sudoers.d/${name}"
  [ ! "${SUDOC}" ] || ${SUDOC} -K; ${SUDOC} true || print Invalid Sudoers Configuration

  umask "${umask}"

  cat >"${tmp}" <<EOF
# shellcheck shell=sh

# Auto generated by: ${name} 

umask ${umask}

# Admin password
export PASSWORD='${PASSWORD}'
# Sudo command
export SUDOC='${SUDOC}'
EOF

  ${SUDOC} mv "${tmp}" "${file}"
  print "${file}"

