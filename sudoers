#!/bin/sh
# shellcheck disable=SC2086
# bashsupport disable=LongLine

#
# sudoers.d update

set -eu

{

name='sudoers'
file="/etc/${name}.sh"
flag='-S'
PASSWORD="${1:-}"
runchroot=', runchroot=*'; man sudoers 2>/dev/null | grep -q runchroot || runchroot=''
runcwd=', runcwd=*'; man sudoers 2>/dev/null | grep -q runcwd || runcwd=''
SUDOC='/usr/bin/sudo'
tmp="$(mktemp)"
umask=0022
 
cat > "${tmp}" <<EOF
# Auto generated by: ${name}

User_Alias ADMINS = %admin, %sudo, %wheel
Defaults:ADMINS always_set_home, !authenticate, !env_reset, !logfile, shell_noargs, !syslog, umask=${umask}, umask_override${runchroot}${runcwd}
EOF

test -x "${SUDOC}" || { SUDOC=''; flag=''; mkdir -p /etc/sudoers.d; }

if [ ! "${PASSWORD}" ]; then
  if [ -f "${file}" ]; then 
    # shellcheck source=/etc/sudoers.sh
    . "${file}"
  elif [ "${SUDOC}" ]; then
    printf '%s' "Enter admin password: " >&2
    read -r PASSWORD
  fi
fi
if echo "${PASSWORD}" | ${SUDOC} ${flag} true 2>/dev/null; then
  echo "${PASSWORD}" | ${SUDOC} ${flag} rm -rf /etc/sudoers.d/* 
  echo "${PASSWORD}" | ${SUDOC} ${flag} cp "${tmp}" "/etc/sudoers.d/${name}"
  [ ! "${SUDOC}" ] || ${SUDOC} -K
  if ! ${SUDOC} true; then
    echo "sudoers: invalid sudoers configuration"; exit 1  
  fi
else
  echo "sudoers: incorrect password: ${PASSWORD}"; exit 1
fi

umask "${umask}"

cat > "${tmp}" << EOF
# shellcheck shell=sh

# Auto generated by: ${name} 

umask ${umask}

# Admin password
export PASSWORD='${PASSWORD}'
# Sudo command
export SUDOC='${SUDOC}'
EOF

${SUDOC} mv "${tmp}" "${file}"

}
