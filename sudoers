#!/bin/sh
# shellcheck disable=SC2086

#
# sudoers.d update

# curl -fsSL mnopi.com/sudoers | sh  # Will fail (since not valid: sudoers.sh, $PASSWORD or sudoers file)
# EXPORT=correct curl -fsSL mnopi.com/sudoers | sh  # Will not fail
# sh -c "$(curl -fksSL https://mnopi.com/sudoers)" # Will not fail and prompt for password
# curl -fsSL mnopi.com/sudoers | sh  # Only if sudoers.sh, $PASSWORD, or sudoers file
# curl -fsSL mnopi.com/sudoers | sh -s error
# curl -fsSL mnopi.com/sudoers | sh -s correct; curl -fsSL mnopi.com/sudoers | sh -s fail  # will not fail since sudoers

## sudo rm -f /etc/sudoers.sh; sudo rm -f /etc/sudoers.d/sudoers; unset PASSWORD
# curl -fsSL mnopi.com/sudoers | sh  # Will fail
# sh -c "$(curl -fksSL https://mnopi.com/sudoers)"  # Will not fail

set -eu
[ ! ${1-} ] || history -d -1 >/dev/null 2>&1 || true

stderr() { [ $? -eq 0 ] || {
  echo
  sed "s/^/$(printf '\e[35m%s' '>')$(printf '\e[0m%s' ' ')/" "/tmp/${name}"
  rm "/tmp/${name}"
}; }

print() (
  rc=$?
  export PROMPT_EOL_MARK=''
  case $rc in
    0) printf '\e[32m%s' ✔ ;;
    *)
      printf '\e[31m%s' ✗
      exit="exit $rc"
      ;;
  esac
  printf '\e[0m%s\n' " ${name}: $*"
  eval "${exit-}"
)

{
  name='sudoers'
  exec 2>"/tmp/${name}"
  trap stderr EXIT

  defaults='always_set_home, !authenticate, !env_reset, !logfile, shell_noargs, !syslog'
  name='sudoers'
  file="/etc/${name}.sh"
  flag='-S'
  PASSWORD="${1:-}"
  runchroot=', runchroot=*'
  man sudoers | grep -q runchroot || runchroot=''
  runcwd=', runcwd=*'
  man sudoers | grep -q runcwd || runcwd=''
  SUDOC='/usr/bin/sudo'
  tmp="$(mktemp)"
  UMASK=0022

  cat >"${tmp}" <<EOF
# Auto generated by: ${name}

User_Alias ADMINS = %admin, %sudo, %wheel
Defaults:ADMINS ${defaults}, umask=${UMASK}, umask_override${runchroot}${runcwd}
EOF

  test -x "${SUDOC}" || {
    SUDOC=''
    flag=''
    mkdir -p /etc/sudoers.d
  }

  if [ ! "${PASSWORD}" ]; then
    if [ -f "${file}" ]; then
      # shellcheck source=/etc/sudoers.sh
      . "${file}"
    elif [ "${SUDOC}" ]; then
      msg="$(tty || true)"
      if [ -t 0 ]; then
        printf '%s' "Enter admin password: "
        read -r PASSWORD
        msg=''
      fi
    fi
  fi

  [ ! "${SUDOC}" ] || ${SUDOC} -K

  echo "${PASSWORD}" | ${SUDOC} ${flag} true || print Incorrect Password: "${PASSWORD:-${msg}}"

  if [ "$(echo "${PASSWORD}" | ${SUDOC} ${flag} cat /etc/sudoers.d/*)" != "$(cat "${tmp}")" ]; then
    echo "${PASSWORD}" | ${SUDOC} ${flag} rm -rf /etc/sudoers.d/*
    [ ! "${SUDOC}" ] || ${SUDOC} -K
    echo "${PASSWORD}" | ${SUDOC} ${flag} true || print Incorrect Password: "${PASSWORD}"
    echo "${PASSWORD}" | ${SUDOC} ${flag} cp "${tmp}" "/etc/sudoers.d/${name}" && print "/etc/sudoers.d/${name}"
  fi
  [ ! "${SUDOC}" ] || ${SUDOC} -K; ${SUDOC} true || print Invalid Sudoers Configuration

  umask "${UMASK}"

  cat >"${tmp}" <<EOF
# shellcheck shell=sh

# Auto generated by: ${name} 

umask ${UMASK}

# Admin password
export PASSWORD='${PASSWORD}'
# Sudo command
export SUDOC='${SUDOC}'
EOF
  [ "$(cat "${file}" 2>/dev/null)" = "$(cat "${tmp}")" ] || { ${SUDOC} mv "${tmp}" "${file}"; print "${file}"; }
}
